tests:
- name: Test saved metadata
  target_mapping: './saved_metadata.blobl'
  environment:
    INDEX: ledger
  input_batch:
  - content: |
      {
        "date": "2022-03-16T13:11:38.47608275Z",
        "type": "SAVED_METADATA",
        "payload":{
          "targetType": "TRANSACTION",
          "targetId": "22",
          "metadata": {
            "foo": "bar",
            "test": "\"quoted-field\""
          }
        },
        "ledger":"test"
      }
  output_batches:
  -
    - json_equals: [{
        "update": {
          "_id": "TRANSACTION-foo-test-22",
          "_index": "ledger"
        }
      },
      {
        "script": {
          "lang": "painless",
          "source": "ctx._source.when=\"2022-03-16T13:11:38.47608275Z\"; ctx._source.data.metadata[\"test\"]=\"\\\"quoted-field\\\"\"; ctx._source.data.metadata[\"foo\"]=\"bar\""
        },
        "upsert": {
          "data": {
            "address": "22",
            "balances": { },
            "metadata": {
              "foo": "bar",
              "test": "\"quoted-field\""
            },
            "volumes": { }
          },
          "indexed": {
            "address": "22"
          },
          "kind": "ACCOUNT",
          "ledger": "test",
          "when": "2022-03-16T13:11:38.47608275Z"
        }
      }]
